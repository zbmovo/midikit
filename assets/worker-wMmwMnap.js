(function(){"use strict";var i=function(t){return t[t.SEQUENCE_NUMBER=0]="SEQUENCE_NUMBER",t[t.TEXT_EVENT=1]="TEXT_EVENT",t[t.COPYRIGHT_NOTICE=2]="COPYRIGHT_NOTICE",t[t.SEQUENCE_TRACK_NAME=3]="SEQUENCE_TRACK_NAME",t[t.INSTRUMENT_NAME=4]="INSTRUMENT_NAME",t[t.LYRIC=5]="LYRIC",t[t.MARKER=6]="MARKER",t[t.CUE_POINT=7]="CUE_POINT",t[t.DEVICE_NAME=9]="DEVICE_NAME",t[t.MIDI_CHANNEL_PREFIX=32]="MIDI_CHANNEL_PREFIX",t[t.MIDI_PORT=33]="MIDI_PORT",t[t.END_OF_TRACK=47]="END_OF_TRACK",t[t.SET_TEMPO=81]="SET_TEMPO",t[t.SMPTE_OFFSET=84]="SMPTE_OFFSET",t[t.TIME_SIGNATURE=88]="TIME_SIGNATURE",t[t.KEY_SIGNATURE=89]="KEY_SIGNATURE",t[t.SEQUENCER_SPECIFIC=127]="SEQUENCER_SPECIFIC",t[t.EVENT=255]="EVENT",t}({}),d=function(t){return t[t.NOTE_OFF=8]="NOTE_OFF",t[t.NOTE_ON=9]="NOTE_ON",t[t.NOTE_AFTERTOUCH=10]="NOTE_AFTERTOUCH",t[t.CONTROLLER=11]="CONTROLLER",t[t.PROGRAM_CHANGE=12]="PROGRAM_CHANGE",t[t.CHANNEL_AFTERTOUCH=13]="CHANNEL_AFTERTOUCH",t[t.PITCH_BEND=14]="PITCH_BEND",t}({}),v=function(t){return t[t.SYSEX_EVENT=240]="SYSEX_EVENT",t[t.SYSEX_EVENT_END=247]="SYSEX_EVENT_END",t}({});function g(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(_){return Object.getOwnPropertyDescriptor(t,_).enumerable})),a.push.apply(a,r)}return a}function n(t){for(var e=1;e<arguments.length;e++){var a=arguments[e]!=null?arguments[e]:{};e%2?g(Object(a),!0).forEach(function(r){S(t,r,a[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):g(Object(a)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(a,r))})}return t}function U(t,e){if(typeof t!="object"||!t)return t;var a=t[Symbol.toPrimitive];if(a!==void 0){var r=a.call(t,e||"default");if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function P(t){var e=U(t,"string");return typeof e=="symbol"?e:e+""}function F(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function x(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,P(r.key),r)}}function H(t,e,a){return e&&x(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}function S(t,e,a){return e=P(e),e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}function h(t){return w(t)||L(t)||V(t)||G()}function w(t){if(Array.isArray(t))return y(t)}function L(t){if(typeof Symbol<"u"&&t[Symbol.iterator]!=null||t["@@iterator"]!=null)return Array.from(t)}function V(t,e){if(t){if(typeof t=="string")return y(t,e);var a=Object.prototype.toString.call(t).slice(8,-1);if(a==="Object"&&t.constructor&&(a=t.constructor.name),a==="Map"||a==="Set")return Array.from(t);if(a==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return y(t,e)}}function y(t,e){(e==null||e>t.length)&&(e=t.length);for(var a=0,r=new Array(e);a<e;a++)r[a]=t[a];return r}function G(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function p(t){var e=0,a=new TextDecoder;function r(){var u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1;return t.subarray(e,e+=u)}function _(){var u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1;return a.decode(r(u))}function E(){var u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1;return r(u).reduce(function(s,T){return s<<8|T},0)}function l(){var u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1;return r(u).reduce(function(s,T,I){return s|T<<I*8},0)}function f(){var u=0;do u++;while(t[e+u]!==0);return _(u)}function m(){for(var u=0;u<<=7,u|=t[e]&127,e++,!!(t[e-1]>>7););return u}return{read:r,readTextAt:_,readIntAt:E,readIntLEAt:l,readText:f,uintvar:m,get ended(){return e>t.length-1}}}function K(t,e){var a=t.uintvar(),r=t.readIntAt(1),_=typeof e>"u"?0:e.startTicks,E={delta:a,event:r,startTicks:a+_,startTime:0,type:"UNKNOWN",name:"UNKNOWN_EVENT",data:null};if(r===v.SYSEX_EVENT){var l=t.uintvar(),f=t.read(l),m=!1;return f[f.length-1]===v.SYSEX_EVENT_END&&(m=!0),n(n({},E),{},{type:"SYSEX",name:"SYSEX_EVENT",data:{done:m,value:h(f)}})}if(r===v.SYSEX_EVENT_END){var u=t.uintvar(),s=t.read(u),T=e,I=T.data,O=!1;return(I.done||typeof I.done>"u"||s[s.length-1]===247)&&(O=!0),n(n({},E),{},{type:"SYSEX",name:"SYSEX_EVENT_END",data:{done:O,value:h(s)}})}if(r===i.EVENT){var C=t.readIntAt(1),c=t.uintvar();switch(E.type="META",C){case i.SEQUENCE_NUMBER:return n(n({},E),{},{name:"SEQUENCE_NUMBER",data:{number:t.readIntAt(2)}});case i.TEXT_EVENT:return n(n({},E),{},{name:"TEXT_EVENT",data:{text:t.readTextAt(c)}});case i.COPYRIGHT_NOTICE:return n(n({},E),{},{name:"COPYRIGHT_NOTICE",data:{text:t.readTextAt(c)}});case i.SEQUENCE_TRACK_NAME:return n(n({},E),{},{name:"SEQUENCE_TRACK_NAME",data:{text:t.readTextAt(c)}});case i.INSTRUMENT_NAME:return n(n({},E),{},{name:"INSTRUMENT_NAME",data:{text:t.readTextAt(c)}});case i.LYRIC:return n(n({},E),{},{name:"LYRIC",data:{text:t.readTextAt(c)}});case i.MARKER:return n(n({},E),{},{name:"MARKER",data:{text:t.readTextAt(c)}});case i.CUE_POINT:return n(n({},E),{},{name:"CUE_POINT",data:{text:t.readTextAt(c)}});case i.DEVICE_NAME:return n(n({},E),{},{name:"DEVICE_NAME",data:{text:t.readTextAt(c)}});case i.MIDI_CHANNEL_PREFIX:return n(n({},E),{},{name:"MIDI_CHANNEL_PREFIX",data:{channel:t.readIntAt(1)}});case i.MIDI_PORT:return n(n({},E),{},{name:"MIDI_PORT",data:{port:t.readIntAt(1)}});case i.END_OF_TRACK:return n(n({},E),{},{name:"END_OF_TRACK",data:null});case i.SET_TEMPO:return n(n({},E),{},{name:"SET_TEMPO",data:{quarterNote:t.readIntAt(3)}});case i.SMPTE_OFFSET:return n(n({},E),{},{name:"SMPTE_OFFSET",data:{hour:t.readIntAt(1),minutes:t.readIntAt(1),seconds:t.readIntAt(1),frames:t.readIntAt(1),fframes:t.readIntAt(1)}});case i.TIME_SIGNATURE:return n(n({},E),{},{name:"TIME_SIGNATURE",data:{numerator:t.readIntAt(1),denominator:Math.pow(t.readIntAt(1),2),clocks:t.readIntAt(1),nd32:t.readIntAt(1)}});case i.KEY_SIGNATURE:return n(n({},E),{},{name:"KEY_SIGNATURE",data:{keySignature:t.readIntAt(1),mode:t.readIntAt(1)}});case i.SEQUENCER_SPECIFIC:return n(n({},E),{},{name:"SEQUENCER_SPECIFIC",data:{manufIDCode:t.readIntAt(c)}})}}else{var N=0;r<128?(N=r,E.event=r=e.event):N=t.readIntAt(1);var R=r>>4,o=r&15;switch(E.type="MIDI",R){case d.NOTE_OFF:return n(n({},E),{},{name:"NOTE_OFF",data:{note:N,velocity:t.readIntAt(1)/127,channel:o}});case d.NOTE_ON:return n(n({},E),{},{name:"NOTE_ON",data:{note:N,velocity:t.readIntAt(1)/127,channel:o}});case d.NOTE_AFTERTOUCH:return n(n({},E),{},{name:"NOTE_AFTERTOUCH",data:{note:N,aftertouch:t.readIntAt(1),channel:o}});case d.CONTROLLER:return n(n({},E),{},{name:"CONTROLLER",data:{number:N,value:t.readIntAt(1),channel:o}});case d.PROGRAM_CHANGE:return n(n({},E),{},{name:"PROGRAM_CHANGE",data:{program:N,channel:o}});case d.CHANNEL_AFTERTOUCH:return n(n({},E),{},{name:"CHANNEL_AFTERTOUCH",data:{aftertouch:N,channel:o}});case d.PITCH_BEND:return n(n({},E),{},{name:"PITCH_BEND",data:{lsb:N,msb:t.readIntAt(1),channel:o}})}}return E}var b=function(){function t(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;F(this,t),S(this,"tpqn",0),S(this,"tempo",5e5),this.tpqn=e}return H(t,[{key:"bpm",get:function(){return 6e7/this.tempo}},{key:"tick",get:function(){return this.tempo/this.tpqn}}])}();function Y(t){for(var e={},a=[],r=p(t),_=["MThd","MTrk"];!r.ended;){var E=r.readTextAt(4),l=r.readIntAt(4),f=r.read(l),m={id:E,size:l,data:f};_.includes(E)?a.push(m):console.error("discover damaged tracks.",m)}var u=a[0],s=a.slice(1);{var T=p(u.data);e.header={format:T.readIntAt(2),ntrks:T.readIntAt(2),division:T.readIntAt(2)}}{var I=function(N){O.format===2&&(C=new b(O.division));for(var R=p(N.data),o=[];!R.ended;){var A=K(R,o[o.length-1]);A.name==="SET_TEMPO"&&(C.tempo=A.data.quarterNote),A.startTime=A.startTicks*C.tick,o.push(A)}return o},O=e.header,C=new b(O.division);e.tracks=s.map(I)}return e}onmessage=t=>{postMessage(Y(new Uint8Array(t.data)))}})();
